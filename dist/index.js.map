{"version":3,"sources":["../code/index.jsy"],"names":["asObjectFunctionalClass","asStateTransform","asFunctionalObject","updateObservable","stateActionDispatch","isObjectChanged","asDispatchCallbackPipeline","g_Observable","require","options","transform","xform","after","concat","viewTransform","freeze","useInitialValue","initialValue","opt","Object","assign","ObjectFunctional","Base","xform_name","TypeError","view","key","keys","host","notify","toJS","value","view_props","host_props","impl_props","Observable","observable","from","bindObservable","defineAction","bindActionDeclarations","injectActions","_injectActions","__impl_proto__","create","getPrototypeOf","__view_proto__","defineProperties","props","subscribe","bind","Symbol","dispatchAction","_asDispatchActionFunction","action","fnActionImpl","actionName","name","fnActionDispatch","actionArgs","defineProperty","configurable","asAction","set","__dispatch__","addObserver","update","_observerColl","current","initial","next","observer","slice","err","removeObserver","error","push","idx","indexOf","splice","initialState","isChanged","on_before","before","__dispatch_before__","on_error","__dispatch_error__","on_after","__dispatch_after__","on_finish","__dispatch_freeze__","on_freeze","undefined","initState","_init_state","state","changed","pre_state","tgt","ctx","apply","setPrototypeOf","shouldThrow","post_state","Error","constructor","Promise","reject","prev","callback","callback_name","Array","isArray","iterator","every","fn","arg1","arg2"],"mappings":"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","file":"index.js","sourcesContent":["const g_Observable = require('any-observable')\n//const g_Observable = 'undefined' !== typeof Observable ? Observable : require('any-observable')\n\nexport default asObjectFunctionalClass\nexport function asObjectFunctionalClass(options={}) ::\n  if options.transform ::\n    const xform = asStateTransform(options.transform, 'transform')\n    options.after = [].concat @ options.after || [], xform\n    \n  if options.viewTransform ::\n    const xform = asStateTransform(options.viewTransform, 'viewTransform')\n    options.freeze = [].concat @ options.freeze || [], xform\n\n  if options.useInitialValue ::\n    return function(initialValue) ::\n      const opt = Object.assign @ {}, options, {initialValue}\n      return asFunctionalObject(this, options)\n  else ::\n    return function() ::\n      return asFunctionalObject(this, options)\n\nexport const ObjectFunctional = asObjectFunctionalClass()\nexport const Base = ObjectFunctional\n\n// --- \n\nexport function asStateTransform(xform, xform_name) ::\n  if 'function' !== typeof xform ::\n    throw new TypeError(`Expected ${xform_name}to be a function`)\n\n  return function (view) ::\n    for const key of Object.keys(view) ::\n      view[key] = xform @ view[key]\n\n// --- \n\nexport function asFunctionalObject(host, options={}) ::\n  const notify = options.notify || updateObservable(options)\n\n  // implement toJS to cooperate with ImmutableJS standard\n  const toJS = @{} value() :: return this\n  const view_props = {toJS}, host_props = {toJS}, impl_props = {}\n\n  ::\n    const Observable = options.Observable || g_Observable\n    const observable = Observable.from(notify.observable || notify)\n    bindObservable(observable)\n\n  const defineAction = bindActionDeclarations @ notify\n  if options.injectActions ::\n    _injectActions(defineAction, options.injectActions)\n\n\n  host_props.__impl_proto__ = @{} value() ::\n    return Object.create @ Object.getPrototypeOf(host), impl_props\n\n  host_props.__view_proto__ = @{} value() ::\n    return Object.create @ Object.getPrototypeOf(host), view_props\n\n  Object.defineProperties @ host, host_props\n  return Object.freeze @ Object.create @ host\n\n\n  function bindObservable(observable) ::\n    for const props of [view_props, host_props, impl_props] ::\n      props.subscribe = @{} value: observable.subscribe.bind(observable)\n      props.observable = @{} value() :: return observable\n      if null != Symbol.observable ::\n        props[Symbol.observable] = props.observable\n\n  function bindActionDeclarations(notify) ::\n    const dispatchAction = _asDispatchActionFunction(host, options)\n    if 'function' !== typeof dispatchAction ::\n      throw new TypeError(`Expected a dispatchAction(notify, actionName, actionArgs){…} function`)\n\n    const defineAction = (action, fnActionImpl) => ::\n      const actionName = action.name\n      const fnActionDispatch = function (...actionArgs) ::\n        return dispatchAction(notify, actionName, actionArgs)\n\n      impl_props[actionName] = @{} value: fnActionImpl || action\n      view_props[actionName] = @{} value: fnActionDispatch\n      Object.defineProperty @ host, actionName,\n        @{} configurable: true, value: fnActionDispatch\n\n    host_props.asAction = @{} set: defineAction\n    return defineAction\n\n// ---\n\nfunction _asDispatchActionFunction(host, options) ::\n  if null != options.dispatchAction ::\n    return options.dispatchAction\n\n  if 'function' === typeof host.__dispatch__ ::\n    return function(notify, actionName, actionArgs) ::\n      return host.__dispatch__(notify, actionName, actionArgs)\n\n  return stateActionDispatch(host, options)\n\n// ---\n\nfunction _injectActions(defineAction, injectActions) ::\n  // allow injecting actions for time traveling debugging, etc.\n  for const name of Object.keys(injectActions) ::\n    const fnActionImpl = injectActions[name]\n    if 'function' !== typeof fnActionImpl ::\n      throw TypeError @ `Overlay action \"${name}\" expected function, not \"${typeof fnActionImpl}\"`\n\n    defineAction({name}, fnActionImpl)\n\n\n// ---\n\n\nexport function updateObservable(options={}) ::\n  ::\n    const Observable = options.Observable || g_Observable\n    const observable = new Observable(addObserver)\n    update.observable = observable\n    if Symbol.observable ::\n      Object.defineProperty @ update, Symbol.observable,\n        @{} value() :: return observable\n\n\n  const _observerColl = []\n  let current = options.initial\n  return update\n\n  function update(next) ::\n    current = next\n    for const observer of _observerColl.slice() ::\n      try :: observer.next(current)\n      catch err ::\n        removeObserver(observer)\n        observer.error(err)\n\n  function addObserver(observer) ::\n    _observerColl.push(observer)\n    observer.next(current)\n    return () => :: removeObserver(observer)\n\n  function removeObserver(observer) ::\n    const idx = _observerColl.indexOf(observer)\n    if idx < 0 :: return false\n    _observerColl.splice(idx, 1)\n    return true\n\n\n// ---\n\n\nexport function stateActionDispatch(host, options={}) ::\n  let initialState = options.initialState\n  const isChanged = options.isChanged || isObjectChanged\n  const on_before = asDispatchCallbackPipeline @ options.before || host.__dispatch_before__, 'before'\n  const on_error = asDispatchCallbackPipeline @ options.error || host.__dispatch_error__, 'error'\n  const on_after = asDispatchCallbackPipeline @ options.after || host.__dispatch_after__, 'after'\n  const on_finish = asDispatchCallbackPipeline @ options.freeze || host.__dispatch_freeze__, 'finish'\n  const on_freeze = asDispatchCallbackPipeline @ options.freeze || host.__dispatch_freeze__, 'freeze'\n\n  if undefined !== isChanged && 'function' !== typeof isChanged ::\n    throw new TypeError @ `Dispatch expected 'isChanged' option to be a function instance`\n\n  if 'function' !== typeof initialState ::\n    if 'function' === typeof host.initState ::\n      initialState = host => host.initState()\n    else ::\n      const _init_state = Object.assign @ {}, initialState\n      initialState = host => _init_state\n\n  let state = undefined\n  return __dispatch__\n  \n  function __dispatch__(notify, actionName, actionArgs) ::\n    let changed\n    if undefined === state ::\n      state = initialState(host)\n      changed = true\n\n    const pre_state = state\n    const tgt = Object.create @ host.__impl_proto__()\n    Object.assign @ tgt, pre_state\n\n    const ctx = @: action: [actionName, actionArgs], pre_state\n    try ::\n      if undefined !== on_before ::\n        on_before(tgt, ctx)\n\n      try ::\n        // dispatch action method\n        tgt[actionName].apply(tgt, actionArgs)\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__())\n\n      catch err ::\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__())\n\n        // handle error from action method\n        if undefined === on_error :: throw err\n\n        const shouldThrow = on_error(err, tgt, ctx)\n        if false !== shouldThrow :: throw err\n\n      if undefined !== on_after ::\n        on_after(tgt, ctx)\n\n      // capture state after dispatching action\n      const post_state = Object.assign @ {}, tgt\n      ctx.post_state = post_state\n\n      if pre_state !== state ::\n        throw new Error @ `Async conflicting update of \"${host.constructor.name}\" occured`\n\n      changed = changed || isChanged(pre_state, post_state)\n      ctx.changed = changed\n      if changed ::\n        state = post_state\n\n      if undefined !== on_finish ::\n        on_finish(tgt, ctx)\n    finally ::\n      if undefined !== on_freeze ::\n        try ::\n          on_freeze(tgt, ctx)\n        catch err ::\n          Promise.reject(err)\n      Object.freeze(tgt)\n\n    if changed :: notify @ tgt\n    return tgt\n\n// ---\n\nexport function isObjectChanged(prev, next) ::\n  for const key of Object.keys(prev) ::\n    if prev[key] !== next[key] ::\n      return true\n\n  for const key of Object.keys(prev) ::\n    if ! @ key in prev ::\n      return true\n\n  return false\n\n// --- \n\nexport function asDispatchCallbackPipeline(callback, callback_name) ::\n  if null == callback :: return\n\n  if 'function' === typeof callback :: return callback\n\n  if Array.isArray(callback) || callback[Symbol.iterator] ::\n    callback = Array.from(callback)\n    if callback.every @ fn => 'function' === typeof fn ::\n      return (tgt, arg1, arg2) => ::\n        for const fn of callback ::\n          try :: fn(tgt, arg1, arg2)\n          catch err ::\n            Promise.reject(err)\n    \n  throw new TypeError @ `Dispatch expected '${callback_name}' option to be a function instance or list of functions`\n\n"]}