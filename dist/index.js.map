{"version":3,"sources":["../code/index.jsy"],"names":["ObjectFunctional","asFunctionalObject","asObservableUpdateFunction","stateActionDispatch","asDispatchCallbackPipeline","isObjectChanged","bindStateTransform","host","options","Observable","_findObservable","Object","assign","notify","view_props","host_props","impl_props","observable","from","subscribe","TypeError","bindObservable","dispatchAction","defineAction","bindActionDeclarations","injectActions","name","keys","fnActionImpl","__impl_proto__","create","getPrototypeOf","__view_proto__","configurable","value","defineProperties","freeze","props","bind","Symbol","__dispatch__","actionName","actionArgs","actionList","Array","isArray","entries","fnAction","fnDispatch","asAction","set","addObserver","update","defineProperty","coll","current","next","observer","slice","err","removeObserver","error","push","idx","indexOf","splice","transform","xform","after","concat","viewTransform","changed","isChanged","__is_changed__","on_before","before","__dispatch_before__","on_error","__dispatch_error__","on_after","__dispatch_after__","on_changed","__dispatch_changed__","on_freeze","__dispatch_freeze__","undefined","state","state_summary","tip_view","view","pre_state","tgt","result","ctx","action","isTipView","apply","setPrototypeOf","shouldThrow","post_state","Error","constructor","change_summary","Promise","reject","callback","host_callback","callback_name","iterator","callbackList","filter","e","some","cb","length","pop","arg1","arg2","prev","key","xform_name","window","global"],"mappings":"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","file":"index.js","sourcesContent":["export function ObjectFunctional() ::\n  return asFunctionalObject(this)\n\n// ---\n\nexport function asFunctionalObject(host, ...options) ::\n  const Observable = _findObservable(options.Observable)\n  :: // initialize options\n    options = Object.assign({}, ...options)\n\n    if null == options.notify ::\n      options.notify = asObservableUpdateFunction(Observable)\n\n\n  // setup notification, observable, and props\n  const notify = options.notify\n  const view_props = {} // properties for immutable views -- where actions are grafted on\n  const host_props = {} // properties to overlay on `host` paramter; uses immutable view actions dispatch\n  const impl_props = {} // properties for mutable clones -- where actions use specified implementation\n  ::\n    const observable = Observable.from(notify.observable || notify)\n    if null == observable || 'function' !== typeof observable.subscribe ::\n      throw new TypeError @ `Notify option is expected to be ES Observable compatible`\n\n    bindObservable(observable)\n\n  // setup asAction setter hack -- in lieu of ES standard decorators\n  const {dispatchAction, defineAction} = bindActionDeclarations(notify)\n  if options.injectActions ::\n    // allow injecting actions for time traveling debugging, etc.\n    for const name of Object.keys(options.injectActions) ::\n      const fnActionImpl = options.injectActions[name]\n      if 'function' !== typeof fnActionImpl ::\n        throw TypeError @ `Overlay action \"${name}\" expected as function, not \"${typeof fnActionImpl}\"`\n\n      defineAction([name, fnActionImpl])\n\n\n  const __impl_proto__ = Object.create @ Object.getPrototypeOf(host), impl_props\n  const __view_proto__ = Object.create @ Object.getPrototypeOf(host), view_props\n  :: // view/impl prototype definitions and host prototype update \n    host_props.__impl_proto__ = @{} configurable: true, value: __impl_proto__\n    host_props.__view_proto__ = @{} configurable: true, value: __view_proto__\n\n    Object.defineProperties @ host, host_props\n\n\n  // initialize the internal stat with initial view\n  dispatchAction(notify, null, [], null)\n\n  // return a frozen clone of the host object\n  return Object.freeze @ Object.create @ host\n\n\n  function bindObservable(observable) ::\n    for const props of [view_props, host_props, impl_props] ::\n      props.subscribe = @{} value: observable.subscribe.bind(observable)\n      props.observable = @{} value() :: return observable\n      if null != Symbol.observable ::\n        props[Symbol.observable] = props.observable\n\n  function bindActionDeclarations(notify) ::\n    let dispatchAction\n    if null != options.dispatchAction ::\n      dispatchAction = options.dispatchAction\n      if 'function' !== typeof dispatchAction ::\n        throw new TypeError(`Expected a dispatchAction(notify, actionName, actionArgs){…} function`)\n    else if 'function' === typeof host.__dispatch__ ::\n      dispatchAction = function(notify, actionName, actionArgs) ::\n        return host.__dispatch__(notify, actionName, actionArgs)\n    else ::\n      dispatchAction = stateActionDispatch(host, options)\n\n\n    const defineAction = (actionList) => ::\n      if 'function' === typeof actionList ::\n        actionList = @[] @[] actionList.name, actionList\n      else if 'string' === typeof actionList ::\n        actionList = @[] @[] actionList, host[actionList]\n      else if ! Array.isArray @ actionList ::\n        actionList = Object.entries(actionList)\n      else if 'string' === typeof actionList[0] ::\n        actionList = @[] actionList\n\n\n      const impl_props={}, view_props={}, host_props = {}\n      for const [actionName, fnAction] of actionList ::\n        if ! actionName ::\n          throw new TypeError @ `Action name not found`\n        if 'function' !== typeof fnAction ::\n          throw new TypeError @ `Expected action \"${actionName}\" to be a function, but found \"${typeof fnAction}\"`\n\n        const fnDispatch = function (...actionArgs) ::\n          return dispatchAction(notify, actionName, actionArgs)\n\n        impl_props[actionName] = @{} value: fnAction\n        view_props[actionName] = @{} value: fnDispatch\n        host_props[actionName] = @{} value: fnDispatch, configurable: true\n\n      Object.defineProperties @ __impl_proto__, impl_props\n      Object.defineProperties @ __view_proto__, view_props\n      Object.defineProperties @ host, host_props\n\n    host_props.asAction = @{} set: defineAction\n    return @{} dispatchAction, defineAction\n\n\n// ---\n\nexport function asObservableUpdateFunction(Observable) ::\n  Observable = _findObservable(Observable)\n  ::\n    const observable = new Observable(addObserver)\n    update.observable = observable\n    if Symbol.observable ::\n      Object.defineProperty @ update, Symbol.observable,\n        @{} value() :: return observable\n\n\n  const coll = []\n  let current\n  return update\n\n  function update(next) ::\n    if current === next :: return\n    current = next\n    for const observer of coll.slice() ::\n      try :: observer.next(current)\n      catch err ::\n        removeObserver(observer)\n        observer.error(err)\n\n  function addObserver(observer) ::\n    coll.push(observer)\n    observer.next(current)\n    return () => :: removeObserver(observer)\n\n  function removeObserver(observer) ::\n    const idx = coll.indexOf(observer)\n    if idx < 0 :: return false\n    coll.splice(idx, 1)\n    return true\n\n\n// ---\n\n\nexport function stateActionDispatch(host, options={}) ::\n  if options.transform ::\n    const xform = bindStateTransform(options.transform, 'transform')\n    options.after = [].concat @ options.after || [], xform\n\n  if options.viewTransform ::\n    const xform = bindStateTransform(options.viewTransform, 'viewTransform')\n    options.changed = [].concat @ options.changed || [], xform\n\n  const isChanged = options.isChanged || host.__is_changed__ || isObjectChanged\n  const on_before = asDispatchCallbackPipeline @ options.before, host.__dispatch_before__, 'before'\n  const on_error = asDispatchCallbackPipeline @ options.error, host.__dispatch_error__, 'error'\n  const on_after = asDispatchCallbackPipeline @ options.after, host.__dispatch_after__, 'after'\n  const on_changed = asDispatchCallbackPipeline @ options.changed, host.__dispatch_changed__, 'changed'\n  const on_freeze = asDispatchCallbackPipeline @ options.freeze, host.__dispatch_freeze__, 'freeze'\n\n  if undefined !== isChanged && 'function' !== typeof isChanged ::\n    throw new TypeError @ `Dispatch expected 'isChanged' option to be a function instance`\n\n  let state = {}, state_summary, tip_view\n  return __dispatch__\n\n  function __dispatch__(notify, actionName, actionArgs, view) ::\n    const pre_state = state\n    const tgt = Object.create @ host.__impl_proto__\n\n    Object.assign @ tgt, state\n\n    let result\n    const ctx = @: action: [actionName, actionArgs, view]\n      , pre_state, isTipView: tip_view === view && view !== undefined\n\n    try ::\n      if undefined !== on_before ::\n        on_before(tgt, ctx)\n\n      try ::\n        // dispatch action method\n        if actionName ::\n          result = tgt[actionName].apply(tgt, actionArgs)\n          ctx.result = result\n        else ::\n          ctx.result = result = tip_view = tgt\n\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__)\n\n      catch err ::\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__)\n\n        // handle error from action method\n        if undefined === on_error :: throw err\n\n        const shouldThrow = on_error(err, tgt, ctx)\n        if false !== shouldThrow :: throw err\n\n      if undefined !== on_after ::\n        on_after(tgt, ctx)\n\n      // capture state after dispatching action\n      const post_state = Object.assign @ {}, tgt\n      ctx.post_state = post_state\n\n      if pre_state !== state ::\n        throw new Error @ `Async conflicting update of \"${host.constructor.name}\" occured`\n\n      const change_summary = isChanged(pre_state, post_state, state_summary, ctx)\n      if change_summary ::\n        ctx.changed = true\n        state = post_state\n        state_summary = change_summary\n        tip_view = tgt\n\n        if undefined !== on_changed ::\n          on_changed(tgt, ctx)\n\n      else if tgt === result ::\n        ctx.result = result = tip_view\n\n    finally ::\n      if undefined !== on_freeze ::\n        try ::\n          on_freeze(tgt, ctx)\n        catch err ::\n          Promise.reject(err)\n      Object.freeze(tgt)\n\n    notify(tip_view)\n    return result\n\n// ---\n\nexport function asDispatchCallbackPipeline(callback, host_callback, callback_name) ::\n  if null != host_callback ::\n    callback = [].concat @ host_callback, callback || []\n  else if null == callback :: return\n\n  if 'function' === typeof callback :: return callback\n\n  if Array.isArray(callback) || callback[Symbol.iterator] ::\n    const callbackList = Array.from(callback).filter(e => null != e)\n\n    if callbackList.some @ cb => 'function' !== typeof cb ::\n      throw new TypeError @ `Dispatch expected '${callback_name}' option to only include functions in list`\n\n    if callbackList.length <= 1 ::\n      callback = callbackList.pop()\n    else ::\n      callback = function (tgt, arg1, arg2) ::\n        for const cb of callbackList ::\n          try :: cb(tgt, arg1, arg2)\n          catch err ::\n            Promise.reject(err)\n\n  if 'function' !== typeof callback ::\n    throw new TypeError @ `Dispatch expected '${callback_name}' option to be a function instance or list of functions`\n  return callback\n\n// ---\n\nexport function isObjectChanged(prev, next) ::\n  if prev === undefined ::\n    return next !== undefined\n\n  for const key of Object.keys(next) ::\n    if ! @ key in prev ::\n      return true // added\n\n  for const key of Object.keys(prev) ::\n    if prev[key] !== next[key] ::\n      return true // changed\n    if ! @ key in next ::\n      return true // removed\n\n  return false\n\n// ---\n\nexport function bindStateTransform(xform, xform_name) ::\n  if 'function' !== typeof xform ::\n    throw new TypeError(`Expected ${xform_name}to be a function`)\n\n  return function(tgt) ::\n    for const key of Object.keys(tgt) ::\n      tgt[key] = xform @ tgt[key]\n\n// ---\n\nfunction _findObservable(Observable) ::\n  if 'function' === typeof Observable ::\n    return Observable\n  if 'function' === typeof asFunctionalObject.Observable ::\n    return asFunctionalObject.Observable\n  if 'undefined' !== typeof window && 'function' === typeof window.Observable ::\n    return window.Observable\n  if 'undefined' !== typeof global && 'function' === typeof global.Observable ::\n    return global.Observable\n  throw new TypeError @ `Unable to locate an ES Observable implementation`\n"]}