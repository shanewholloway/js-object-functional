{"version":3,"sources":["../code/index.jsy"],"names":["ObjectFunctional","asFunctionalObject","bindUpdateFunction","stateActionDispatch","asDispatchCallbackPipeline","isObjectChanged","bindStateTransform","host","options","Object","assign","notify","dispatchAction","defineAction","bindActionDeclarations","actions","subscribe","value","cb","__impl_proto__","create","getPrototypeOf","__view_proto__","defineProperties","asAction","set","configurable","freeze","TypeError","__dispatch__","actionName","actionArgs","actionList","name","Array","isArray","entries","impl_props","view_props","host_props","fnAction","fnDispatch","notifyList","current","update","next","err","discard","callback","indexOf","concat","unsubscribe","filter","e","transform","xform","after","viewTransform","changed","isChanged","__is_changed__","on_before","before","__dispatch_before__","on_error","error","__dispatch_error__","on_after","__dispatch_after__","on_changed","__dispatch_changed__","on_freeze","__dispatch_freeze__","undefined","state","state_summary","tip_view","view","pre_state","tgt","result","ctx","action","isTipView","apply","setPrototypeOf","shouldThrow","post_state","Error","constructor","change_summary","Promise","reject","host_callback","callback_name","Symbol","iterator","callbackList","from","some","length","pop","arg1","arg2","prev","key","keys","xform_name"],"mappings":"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","file":"index.js","sourcesContent":["export function ObjectFunctional() ::\n  return asFunctionalObject(this)\n\n// ---\n\nexport function asFunctionalObject(host, ...options) ::\n  // initialize options\n  options = Object.assign({}, ...options)\n  const notify = null == options.notify\n    ? bindUpdateFunction(host, options)\n    : options.notify\n\n\n\n  // setup asAction setter hack -- in lieu of ES standard decorators\n  const {dispatchAction, defineAction} = bindActionDeclarations(notify)\n  if options.actions :: defineAction(options.actions)\n\n  const subscribe = @{} value(cb) :: return notify.subscribe(cb)\n  const __impl_proto__ = Object.create @ Object.getPrototypeOf(host), @{} subscribe\n  const __view_proto__ = Object.create @ Object.getPrototypeOf(host), @{} subscribe\n\n  Object.defineProperties @ host, @{}\n      subscribe, asAction: @{} set: defineAction\n    , __impl_proto__: @{} configurable: true, value: __impl_proto__\n    , __view_proto__: @{} configurable: true, value: __view_proto__\n\n\n  // initialize the internal stat with initial view\n  dispatchAction(notify, null, [], null)\n\n  // return a frozen clone of the host object\n  return Object.freeze @ Object.create @ host\n\n\n  function bindActionDeclarations(notify) ::\n    let dispatchAction\n    if null != options.dispatchAction ::\n      dispatchAction = options.dispatchAction\n      if 'function' !== typeof dispatchAction ::\n        throw new TypeError(`Expected a dispatchAction(notify, actionName, actionArgs){…} function`)\n    else if 'function' === typeof host.__dispatch__ ::\n      dispatchAction = function(notify, actionName, actionArgs) ::\n        return host.__dispatch__(notify, actionName, actionArgs)\n    else ::\n      dispatchAction = stateActionDispatch(host, options)\n\n\n    const defineAction = (actionList) => ::\n      if 'function' === typeof actionList ::\n        actionList = @[] @[] actionList.name, actionList\n      else if 'string' === typeof actionList ::\n        actionList = @[] @[] actionList, host[actionList]\n      else if ! Array.isArray @ actionList ::\n        actionList = Object.entries(actionList)\n      else if 'string' === typeof actionList[0] ::\n        actionList = @[] actionList\n\n\n      const impl_props={}, view_props={}, host_props = {}\n      for const [actionName, fnAction] of actionList ::\n        if ! actionName ::\n          throw new TypeError @ `Action name not found`\n        if 'function' !== typeof fnAction ::\n          throw new TypeError @ `Expected action \"${actionName}\" to be a function, but found \"${typeof fnAction}\"`\n\n        const fnDispatch = function (...actionArgs) ::\n          return dispatchAction(notify, actionName, actionArgs)\n\n        impl_props[actionName] = @{} value: fnAction\n        view_props[actionName] = @{} value: fnDispatch\n        host_props[actionName] = @{} value: fnDispatch, configurable: true\n\n      Object.defineProperties @ __impl_proto__, impl_props\n      Object.defineProperties @ __view_proto__, view_props\n      Object.defineProperties @ host, host_props\n\n    return @{} dispatchAction, defineAction\n\n\n// ---\n\nexport function bindUpdateFunction() ::\n  let notifyList = []\n  let current\n\n  update.subscribe = subscribe\n  return update\n\n  function update(next) ::\n    if current === next :: return\n\n    current = next\n    for const cb of notifyList ::\n      try :: cb(current)\n      catch err :: discard(cb)\n\n  function subscribe(callback) ::\n    if -1 !== notifyList.indexOf(callback) ::\n      return\n    if 'function' !== typeof callback ::\n      throw new TypeError @ `Please subscribe with a function`\n\n    notifyList = notifyList.concat @ [callback]\n    callback(current)\n    unsubscribe.unsubscribe = unsubscribe\n    return unsubscribe\n\n    function unsubscribe() ::\n      discard(callback)\n\n  function discard(callback) ::\n    notifyList = notifyList\n      .filter @ e => callback !== e\n\n// ---\n\n\nexport function stateActionDispatch(host, options={}) ::\n  if options.transform ::\n    const xform = bindStateTransform(options.transform, 'transform')\n    options.after = [].concat @ options.after || [], xform\n\n  if options.viewTransform ::\n    const xform = bindStateTransform(options.viewTransform, 'viewTransform')\n    options.changed = [].concat @ options.changed || [], xform\n\n  const isChanged = options.isChanged || host.__is_changed__ || isObjectChanged\n  const on_before = asDispatchCallbackPipeline @ options.before, host.__dispatch_before__, 'before'\n  const on_error = asDispatchCallbackPipeline @ options.error, host.__dispatch_error__, 'error'\n  const on_after = asDispatchCallbackPipeline @ options.after, host.__dispatch_after__, 'after'\n  const on_changed = asDispatchCallbackPipeline @ options.changed, host.__dispatch_changed__, 'changed'\n  const on_freeze = asDispatchCallbackPipeline @ options.freeze, host.__dispatch_freeze__, 'freeze'\n\n  if undefined !== isChanged && 'function' !== typeof isChanged ::\n    throw new TypeError @ `Dispatch expected 'isChanged' option to be a function instance`\n\n  let state = {}, state_summary, tip_view\n  return __dispatch__\n\n  function __dispatch__(notify, actionName, actionArgs, view) ::\n    const pre_state = state\n    const tgt = Object.create @ host.__impl_proto__\n\n    Object.assign @ tgt, state\n\n    let result\n    const ctx = @: action: [actionName, actionArgs, view]\n      , pre_state, isTipView: tip_view === view && view !== undefined\n\n    try ::\n      if undefined !== on_before ::\n        on_before(tgt, ctx)\n\n      try ::\n        // dispatch action method\n        if actionName ::\n          result = tgt[actionName].apply(tgt, actionArgs)\n          ctx.result = result\n        else ::\n          ctx.result = result = tip_view = tgt\n\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__)\n\n      catch err ::\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__)\n\n        // handle error from action method\n        if undefined === on_error :: throw err\n\n        const shouldThrow = on_error(err, tgt, ctx)\n        if false !== shouldThrow :: throw err\n\n      if undefined !== on_after ::\n        on_after(tgt, ctx)\n\n      // capture state after dispatching action\n      const post_state = Object.assign @ {}, tgt\n      ctx.post_state = post_state\n\n      if pre_state !== state ::\n        throw new Error @ `Async conflicting update of \"${host.constructor.name}\" occured`\n\n      const change_summary = isChanged(pre_state, post_state, state_summary, ctx)\n      if change_summary ::\n        ctx.changed = true\n        state = post_state\n        state_summary = change_summary\n        tip_view = tgt\n\n        if undefined !== on_changed ::\n          on_changed(tgt, ctx)\n\n      else if tgt === result ::\n        ctx.result = result = tip_view\n\n    finally ::\n      if undefined !== on_freeze ::\n        try ::\n          on_freeze(tgt, ctx)\n        catch err ::\n          Promise.reject(err)\n      Object.freeze(tgt)\n\n    notify(tip_view)\n    return result\n\n// ---\n\nexport function asDispatchCallbackPipeline(callback, host_callback, callback_name) ::\n  if null != host_callback ::\n    callback = [].concat @ host_callback, callback || []\n  else if null == callback :: return\n\n  if 'function' === typeof callback :: return callback\n\n  if Array.isArray(callback) || callback[Symbol.iterator] ::\n    const callbackList = Array.from(callback).filter(e => null != e)\n\n    if callbackList.some @ cb => 'function' !== typeof cb ::\n      throw new TypeError @ `Dispatch expected '${callback_name}' option to only include functions in list`\n\n    if callbackList.length <= 1 ::\n      callback = callbackList.pop()\n    else ::\n      callback = function (tgt, arg1, arg2) ::\n        for const cb of callbackList ::\n          try :: cb(tgt, arg1, arg2)\n          catch err ::\n            Promise.reject(err)\n\n  if 'function' !== typeof callback ::\n    throw new TypeError @ `Dispatch expected '${callback_name}' option to be a function instance or list of functions`\n  return callback\n\n// ---\n\nexport function isObjectChanged(prev, next) ::\n  if prev === undefined ::\n    return next !== undefined\n\n  for const key of Object.keys(next) ::\n    if ! @ key in prev ::\n      return true // added\n\n  for const key of Object.keys(prev) ::\n    if prev[key] !== next[key] ::\n      return true // changed\n    if ! @ key in next ::\n      return true // removed\n\n  return false\n\n// ---\n\nexport function bindStateTransform(xform, xform_name) ::\n  if 'function' !== typeof xform ::\n    throw new TypeError(`Expected ${xform_name}to be a function`)\n\n  return function(tgt) ::\n    for const key of Object.keys(tgt) ::\n      tgt[key] = xform @ tgt[key]\n\n"]}