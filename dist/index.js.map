{"version":3,"sources":["../code/index.jsy"],"names":["ObjectFunctional","asFunctionalObject","asObservableUpdateFunction","stateActionDispatch","asDispatchCallbackPipeline","isObjectChanged","bindStateTransform","host","options","Observable","_findObservable","Object","assign","notify","view_props","host_props","impl_props","observable","from","subscribe","TypeError","bindObservable","dispatchAction","defineAction","bindActionDeclarations","injectActions","name","keys","fnActionImpl","__impl_proto__","value","create","getPrototypeOf","__view_proto__","defineProperties","freeze","props","bind","Symbol","__dispatch__","actionName","actionArgs","action","fnActionDispatch","defineProperty","configurable","asAction","set","addObserver","update","coll","current","next","observer","slice","err","removeObserver","error","push","idx","indexOf","splice","transform","xform","after","concat","viewTransform","changed","isChanged","__is_changed__","on_before","before","__dispatch_before__","on_error","__dispatch_error__","on_after","__dispatch_after__","on_changed","__dispatch_changed__","on_freeze","__dispatch_freeze__","undefined","state","state_summary","tip_view","view","pre_state","tgt","result","ctx","isTipView","apply","setPrototypeOf","shouldThrow","post_state","Error","constructor","change_summary","Promise","reject","callback","host_callback","callback_name","Array","isArray","iterator","callbackList","filter","e","some","cb","length","pop","arg1","arg2","prev","key","xform_name","window","global"],"mappings":"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","file":"index.js","sourcesContent":["export function ObjectFunctional() ::\n  return asFunctionalObject(this)\n\n// ---\n\nexport function asFunctionalObject(host, ...options) ::\n  const Observable = _findObservable(options.Observable)\n  :: // initialize options\n    options = Object.assign({}, ...options)\n\n    if null == options.notify ::\n      options.notify = asObservableUpdateFunction(Observable)\n\n\n  // setup notification, observable, and props\n  const notify = options.notify\n  const view_props = {} // properties for immutable views -- where actions are grafted on\n  const host_props = {} // properties to overlay on `host` paramter; uses immutable view actions dispatch\n  const impl_props = {} // properties for mutable clones -- where actions use specified implementation\n  ::\n    const observable = Observable.from(notify.observable || notify)\n    if null == observable || 'function' !== typeof observable.subscribe ::\n      throw new TypeError @ `Notify option is expected to be ES Observable compatible`\n\n    bindObservable(observable)\n\n  // setup asAction setter hack -- in lieu of ES standard decorators\n  const {dispatchAction, defineAction} = bindActionDeclarations(notify)\n  if options.injectActions ::\n    // allow injecting actions for time traveling debugging, etc.\n    for const name of Object.keys(options.injectActions) ::\n      const fnActionImpl = options.injectActions[name]\n      if 'function' !== typeof fnActionImpl ::\n        throw TypeError @ `Overlay action \"${name}\" expected as function, not \"${typeof fnActionImpl}\"`\n\n      defineAction({name}, fnActionImpl)\n\n\n  :: // view/impl prototype definitions and host prototype update \n    host_props.__impl_proto__ = @{} value() ::\n      return Object.create @ Object.getPrototypeOf(host), impl_props\n\n    host_props.__view_proto__ = @{} value() ::\n      return Object.create @ Object.getPrototypeOf(host), view_props\n\n    Object.defineProperties @ host, host_props\n\n  // initialize the dispatch with \n  dispatchAction(notify)\n\n  // return a frozen clone of the host object\n  return Object.freeze @ Object.create @ host\n\n\n  function bindObservable(observable) ::\n    for const props of [view_props, host_props, impl_props] ::\n      props.subscribe = @{} value: observable.subscribe.bind(observable)\n      props.observable = @{} value() :: return observable\n      if null != Symbol.observable ::\n        props[Symbol.observable] = props.observable\n\n  function bindActionDeclarations(notify) ::\n    let dispatchAction\n    if null != options.dispatchAction ::\n      dispatchAction = options.dispatchAction\n      if 'function' !== typeof dispatchAction ::\n        throw new TypeError(`Expected a dispatchAction(notify, actionName, actionArgs){…} function`)\n    else if 'function' === typeof host.__dispatch__ ::\n      dispatchAction = function(notify, actionName, actionArgs) ::\n        return host.__dispatch__(notify, actionName, actionArgs)\n    else ::\n      dispatchAction = stateActionDispatch(host, options)\n\n\n    const defineAction = (action, fnActionImpl) => ::\n      const actionName = action.name\n      const fnActionDispatch = function (...actionArgs) ::\n        return dispatchAction(notify, actionName, actionArgs, this)\n\n      impl_props[actionName] = @{} value: fnActionImpl || action\n      view_props[actionName] = @{} value: fnActionDispatch\n      Object.defineProperty @ host, actionName,\n        @{} configurable: true, value: fnActionDispatch\n\n    host_props.asAction = @{} set: defineAction\n    return @{} dispatchAction, defineAction\n\n\n// ---\n\nexport function asObservableUpdateFunction(Observable) ::\n  Observable = _findObservable(Observable)\n  ::\n    const observable = new Observable(addObserver)\n    update.observable = observable\n    if Symbol.observable ::\n      Object.defineProperty @ update, Symbol.observable,\n        @{} value() :: return observable\n\n\n  const coll = []\n  let current\n  return update\n\n  function update(next) ::\n    if current === next :: return\n    current = next\n    for const observer of coll.slice() ::\n      try :: observer.next(current)\n      catch err ::\n        removeObserver(observer)\n        observer.error(err)\n\n  function addObserver(observer) ::\n    coll.push(observer)\n    observer.next(current)\n    return () => :: removeObserver(observer)\n\n  function removeObserver(observer) ::\n    const idx = coll.indexOf(observer)\n    if idx < 0 :: return false\n    coll.splice(idx, 1)\n    return true\n\n\n// ---\n\n\nexport function stateActionDispatch(host, options={}) ::\n  if options.transform ::\n    const xform = bindStateTransform(options.transform, 'transform')\n    options.after = [].concat @ options.after || [], xform\n\n  if options.viewTransform ::\n    const xform = bindStateTransform(options.viewTransform, 'viewTransform')\n    options.changed = [].concat @ options.changed || [], xform\n\n  const isChanged = options.isChanged || host.__is_changed__ || isObjectChanged\n  const on_before = asDispatchCallbackPipeline @ options.before, host.__dispatch_before__, 'before'\n  const on_error = asDispatchCallbackPipeline @ options.error, host.__dispatch_error__, 'error'\n  const on_after = asDispatchCallbackPipeline @ options.after, host.__dispatch_after__, 'after'\n  const on_changed = asDispatchCallbackPipeline @ options.changed, host.__dispatch_changed__, 'changed'\n  const on_freeze = asDispatchCallbackPipeline @ options.freeze, host.__dispatch_freeze__, 'freeze'\n\n  if undefined !== isChanged && 'function' !== typeof isChanged ::\n    throw new TypeError @ `Dispatch expected 'isChanged' option to be a function instance`\n\n  let state = {}, state_summary, tip_view\n  return __dispatch__\n\n  function __dispatch__(notify, actionName, actionArgs, view) ::\n    const pre_state = state\n    const tgt = Object.create @ host.__impl_proto__()\n\n    Object.assign @ tgt, state\n\n    let result\n    const ctx = @: action: [actionName, actionArgs, view]\n      , pre_state, isTipView: tip_view === view && view !== undefined\n\n    try ::\n      if undefined !== on_before ::\n        on_before(tgt, ctx)\n\n      try ::\n        // dispatch action method\n        if actionName ::\n          result = tgt[actionName].apply(tgt, actionArgs)\n          ctx.result = result\n        else ::\n          if undefined === tip_view :: tip_view = tgt\n          ctx.result = result = tgt\n\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__())\n\n      catch err ::\n        // transform from impl down to a view\n        Object.setPrototypeOf(tgt, host.__view_proto__())\n\n        // handle error from action method\n        if undefined === on_error :: throw err\n\n        const shouldThrow = on_error(err, tgt, ctx)\n        if false !== shouldThrow :: throw err\n\n      if undefined !== on_after ::\n        on_after(tgt, ctx)\n\n      // capture state after dispatching action\n      const post_state = Object.assign @ {}, tgt\n      ctx.post_state = post_state\n\n      if pre_state !== state ::\n        throw new Error @ `Async conflicting update of \"${host.constructor.name}\" occured`\n\n      const change_summary = isChanged(pre_state, post_state, state_summary, ctx)\n      if change_summary ::\n        ctx.changed = true\n        state = post_state\n        state_summary = change_summary\n        tip_view = tgt\n\n        if undefined !== on_changed ::\n          on_changed(tgt, ctx)\n\n      else if tgt === result ::\n        ctx.result = result = tip_view\n\n    finally ::\n      if undefined !== on_freeze ::\n        try ::\n          on_freeze(tgt, ctx)\n        catch err ::\n          Promise.reject(err)\n      Object.freeze(tgt)\n\n    notify(tgt)\n    return result\n\n// ---\n\nexport function asDispatchCallbackPipeline(callback, host_callback, callback_name) ::\n  if null != host_callback ::\n    callback = [].concat @ host_callback, callback || []\n  else if null == callback :: return\n\n  if 'function' === typeof callback :: return callback\n\n  if Array.isArray(callback) || callback[Symbol.iterator] ::\n    const callbackList = Array.from(callback).filter(e => null != e)\n\n    if callbackList.some @ cb => 'function' !== typeof cb ::\n      throw new TypeError @ `Dispatch expected '${callback_name}' option to only include functions in list`\n\n    if callbackList.length <= 1 ::\n      callback = callbackList.pop()\n    else ::\n      callback = function (tgt, arg1, arg2) ::\n        for const cb of callbackList ::\n          try :: cb(tgt, arg1, arg2)\n          catch err ::\n            Promise.reject(err)\n\n  if 'function' !== typeof callback ::\n    throw new TypeError @ `Dispatch expected '${callback_name}' option to be a function instance or list of functions`\n  return callback\n\n// ---\n\nexport function isObjectChanged(prev, next, state_summary, tgt) ::\n  if prev === undefined ::\n    return next !== undefined\n\n  for const key of Object.keys(next) ::\n    if ! @ key in prev ::\n      return true // added\n\n  for const key of Object.keys(prev) ::\n    if prev[key] !== next[key] ::\n      return true // changed\n    if ! @ key in next ::\n      return true // removed\n\n  return false\n\n// ---\n\nexport function bindStateTransform(xform, xform_name) ::\n  if 'function' !== typeof xform ::\n    throw new TypeError(`Expected ${xform_name}to be a function`)\n\n  return function(tgt) ::\n    for const key of Object.keys(tgt) ::\n      tgt[key] = xform @ tgt[key]\n\n// ---\n\nfunction _findObservable(Observable) ::\n  if 'function' === typeof Observable ::\n    return Observable\n  if 'function' === typeof asFunctionalObject.Observable ::\n    return asFunctionalObject.Observable\n  if 'undefined' !== typeof window && 'function' === typeof window.Observable ::\n    return window.Observable\n  if 'undefined' !== typeof global && 'function' === typeof global.Observable ::\n    return global.Observable\n  throw new TypeError @ `Unable to locate an ES Observable implementation`\n"]}