{"version":3,"sources":["../code/index.jsy"],"names":["asFunctionalObject","stateUpdateObservable","stateActionDispatch","isObjectChanged","ObjectFunctional","constructor","Base","host","options","notify","view_props","host_props","impl_props","undefined","observable","bindObservable","bindActionDeclarations","_asDispatchActionFunction","__impl_proto__","value","Object","create","getPrototypeOf","__view_proto__","defineProperties","freeze","props","subscribe","bind","Symbol","dispatchAction","TypeError","asAction","set","action","actionName","name","fnAction","args","defineProperty","configurable","__dispatch__","actionArgs","initialState","onNotifyError","_observerColl","lastState","err","console","error","update","addObserver","state","ob","next","observer","push","idx","indexOf","splice","isChanged","on_before","before","__dispatch_before__","on_error","__dispatch_error__","on_after","after","__dispatch_after__","initState","_init_state","assign","pre_state","tgt","post_state","setPrototypeOf","Error","changed","prev","key"],"mappings":"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","file":"index.js","sourcesContent":["import Observable from 'any-observable'\n\nexport class ObjectFunctional ::\n  constructor() ::\n    return asFunctionalObject @ this\nexport const Base = ObjectFunctional\n\nexport default asFunctionalObject\nexport function asFunctionalObject(host, options={}) ::\n  const notify = options.notify || stateUpdateObservable()\n\n  const view_props = {}, host_props = {}, impl_props = {}\n  if undefined !== notify.observable ::\n    bindObservable(notify.observable)\n\n  bindActionDeclarations @ notify,\n    _asDispatchActionFunction(host, options)\n\n  host_props.__impl_proto__ = @{} value() ::\n    return Object.create @ Object.getPrototypeOf(host), impl_props\n\n  host_props.__view_proto__ = @{} value() ::\n    return Object.create @ Object.getPrototypeOf(host), view_props\n\n  Object.defineProperties @ host, host_props\n  return Object.freeze @ Object.create @ host\n\n\n  function bindObservable(observable) ::\n    for const props of [view_props, host_props, impl_props] ::\n      props.subscribe = @{} value: observable.subscribe.bind(observable)\n      props.observable = @{} value() :: return observable\n      if null != Symbol.observable ::\n        props[Symbol.observable] = props.observable\n\n  function bindActionDeclarations(notify, dispatchAction) ::\n    if 'function' !== typeof dispatchAction ::\n      throw new TypeError(`Expected a dispatchAction(notify, actionName, actionArgs){â€¦} function`)\n\n    host_props.asAction = @{} set: action => ::\n      const actionName = action.name\n      const fnAction = function (...args) ::\n        return dispatchAction(notify, actionName, args)\n\n      impl_props[actionName] = @{} value: action\n      view_props[actionName] = @{} value: fnAction\n      Object.defineProperty @ host, actionName, @{} configurable: true, value: fnAction\n\n\nfunction _asDispatchActionFunction(host, options) ::\n  if null != options.dispatchAction ::\n    return options.dispatchAction\n\n  if 'function' === typeof host.__dispatch__ ::\n    return function(notify, actionName, actionArgs) ::\n      return host.__dispatch__(notify, actionName, actionArgs)\n\n  return stateActionDispatch(host, options)\n\n\n// ---\n\n\nexport function stateUpdateObservable(initialState, onNotifyError) ::\n  const _observerColl = []\n\n  let lastState = initialState\n  if null == onNotifyError ::\n    onNotifyError = err =>\n      console.error(\"Notification error ::\\n\", err)\n\n  update.observable = new Observable(addObserver)\n  return update\n\n  function update(state) ::\n    lastState = state\n    for const ob of _observerColl ::\n      try :: ob.next(state)\n      catch err :: onNotifyError(err)\n\n  function addObserver(observer) ::\n    _observerColl.push(observer)\n    observer.next(lastState)\n    return () => ::\n      const idx = _observerColl.indexOf(observer)\n      if idx >= 0 ::\n        _observerColl.splice(idx, 1)\n\n\n// ---\n\n\nexport function stateActionDispatch(host, options={}) ::\n  let initialState = options.initialState\n  const isChanged = options.isChanged || isObjectChanged\n  const on_before = options.before || host.__dispatch_before__\n  const on_error = options.error || host.__dispatch_error__\n  const on_after = options.after || host.__dispatch_after__\n\n  if undefined !== isChanged && 'function' !== typeof isChanged ::\n    throw new TypeError @ `Dispatch expected 'isChanged' option to be a function instance`\n  if undefined !== on_before && 'function' !== typeof on_before ::\n    throw new TypeError @ `Dispatch expected 'before' option to be a function instance`\n  if undefined !== on_error && 'function' !== typeof on_error ::\n    throw new TypeError @ `Dispatch expected 'error' option to be a function instance`\n  if undefined !== on_after && 'function' !== typeof on_after ::\n    throw new TypeError @ `Dispatch expected 'after' option to be a function instance`\n\n  if 'function' !== typeof initialState ::\n    if 'function' === typeof host.initState ::\n      initialState = host => host.initState()\n    else ::\n      const _init_state = Object.assign @ {}, initialState\n      initialState = host => _init_state\n\n  let state = undefined\n  return function(notify, actionName, actionArgs) ::\n    if undefined === state ::\n      state = initialState(host)\n\n    const pre_state = state\n\n    const tgt = Object.create @ host.__impl_proto__()\n    Object.assign @ tgt, state\n\n    if undefined !== on_before ::\n      on_before @ tgt, @: action: [actionName, actionArgs], state: pre_state\n\n    let post_state\n    try ::\n      tgt[actionName](...actionArgs)\n      post_state = Object.assign @ {}, tgt\n\n    catch err ::\n      if undefined === on_error :: throw err\n\n      on_error @ err, tgt, @: action: [actionName, actionArgs], pre_state\n\n    finally ::\n      // degrade into a view-only\n      Object.setPrototypeOf(tgt, host.__view_proto__())\n      Object.freeze(tgt)\n\n\n    if pre_state !== state ::\n      throw new Error @ `Async conflicting update of \"${host.constructor.name}\" occured`\n\n    const changed = isChanged(pre_state, post_state)\n    if changed :: state = post_state\n\n    if undefined !== on_after ::\n      on_after @ tgt, @: changed, action: [actionName, actionArgs], pre_state, post_state\n\n    if changed :: notify @ tgt\n\n    return tgt\n\n// ---\n\nexport function isObjectChanged(prev, next) ::\n  for const key in prev ::\n    if prev[key] !== next[key] ::\n      return true\n\n  for const key in next ::\n    if ! @ key in prev ::\n      return true\n\n  return false\n\n"]}